================================================================================
                 DOCUMENTACI√ìN COMPLETA - SISTEMA DE TESORER√çA
                          Linguistika Studio v2
================================================================================

AUTOR: Sistema de documentaci√≥n t√©cnica
FECHA: 17 de febrero de 2026
VERSI√ìN: Tesorer√≠a v2 (Sistema de Cuentas Corrientes + Compensaci√≥n Autom√°tica)

================================================================================
üìã √çNDICE
================================================================================

1. INTRODUCCI√ìN Y ARQUITECTURA GENERAL
2. GLOSARIO DE T√âRMINOS
3. MODELO DE BASE DE DATOS
   3.1. Tabla: encargados
   3.2. Tabla: tesoreria_cuentas_corrientes
   3.3. Tabla: tesoreria_obligaciones
   3.4. Tabla: tesoreria_pagos
   3.5. Tabla: tesoreria_aplicaciones
   3.6. Tabla: movimientos_dinero (Legacy)
4. VISTAS SQL Y C√ÅLCULOS AUTOM√ÅTICOS
   4.1. Vista: tesoreria_saldos_encargados_v1
   4.2. Vista: tesoreria_saldos_tutores_v1
   4.3. Vista: tesoreria_libro_diario_v1
5. FUNCIONES RPC (Remote Procedure Call)
6. API BACKEND - ENDPOINTS
   6.1. GET /tesoreria/encargados/resumen
   6.2. GET /tesoreria/tutores/resumen
   6.3. GET /tesoreria/resumen
   6.4. GET /tesoreria/bolsa
   6.5. GET /tesoreria/diario
   6.6. POST /tesoreria/encargados/:encargadoId/pagos
   6.7. POST /tesoreria/tutores/:tutorId/pagos
   6.8. POST /tesoreria/pagos/:pagoId/comprobante
   6.9. POST /tesoreria/grupos/:grupoId/cobro
7. FLUJOS COMPLETOS DEL SISTEMA
   7.1. Flujo: Marcar sesi√≥n como dada
   7.2. Flujo: Encargado realiza un pago
   7.3. Flujo: Aplicaci√≥n autom√°tica FIFO
   7.4. Flujo: Pago a tutor
   7.5. Flujo: Cobro grupal (bulk)
8. SISTEMA DE COMPENSACI√ìN AUTOM√ÅTICA
   8.1. Problema identificado
   8.2. Soluci√≥n implementada
   8.3. F√≥rmula de balance neto
   8.4. Estados contables
   8.5. L√≥gica en SQL
   8.6. L√≥gica en Backend
   8.7. L√≥gica en Frontend
9. CASOS DE USO Y EJEMPLOS PR√ÅCTICOS
10. REGLAS DE NEGOCIO
11. FRONTEND - COMPONENTES Y UI
12. MANTENIMIENTO Y TROUBLESHOOTING

================================================================================
1. INTRODUCCI√ìN Y ARQUITECTURA GENERAL
================================================================================

El Sistema de Tesorer√≠a de Linguistika Studio es un m√≥dulo de contabilidad
completo que gestiona:

‚û§ CUENTAS CORRIENTES por Encargado (padres/responsables) y Tutor
‚û§ OBLIGACIONES (lo que SE ESPERA cobrar o pagar)
‚û§ PAGOS (lo que SE RECIBI√ì o SE PAG√ì realmente)
‚û§ APLICACIONES autom√°ticas (vincular pagos a obligaciones pendientes)
‚û§ COMPENSACI√ìN autom√°tica (deudas vs saldos a favor)

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    ARQUITECTURA DEL SISTEMA                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                   ‚îÇ
‚îÇ  Frontend (React + TypeScript)                                   ‚îÇ
‚îÇ  ‚îî‚îÄ> LInguistika-Studio/views/Tesoreria.tsx                     ‚îÇ
‚îÇ       ‚Ä¢ Vista de encargados con saldos                           ‚îÇ
‚îÇ       ‚Ä¢ Registro de pagos                                        ‚îÇ
‚îÇ       ‚Ä¢ Libro diario                                             ‚îÇ
‚îÇ       ‚Ä¢ Bolsa (efectivo en caja)                                 ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ  Backend (Node.js + Express)                                     ‚îÇ
‚îÇ  ‚îî‚îÄ> backend/routes/tesoreria.js                                ‚îÇ
‚îÇ       ‚Ä¢ 18 endpoints REST                                        ‚îÇ
‚îÇ       ‚Ä¢ Validaci√≥n de datos                                      ‚îÇ
‚îÇ       ‚Ä¢ L√≥gica de aplicaci√≥n FIFO                               ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ  Base de Datos (PostgreSQL en Supabase)                         ‚îÇ
‚îÇ  ‚îî‚îÄ> backend/migrations/017_tesoreria_v2_*.sql                  ‚îÇ
‚îÇ       ‚Ä¢ 5 tablas principales                                     ‚îÇ
‚îÇ       ‚Ä¢ 3 vistas calculadas                                      ‚îÇ
‚îÇ       ‚Ä¢ 2 funciones RPC                                          ‚îÇ
‚îÇ       ‚Ä¢ Sistema de compensaci√≥n autom√°tica                       ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

FILOSOF√çA DE DISE√ëO:
--------------------
‚úì Doble entrada contable (libro diario con debe/haber)
‚úì Separaci√≥n entre LO ESPERADO (obligaciones) y LO REAL (pagos)
‚úì Aplicaci√≥n autom√°tica FIFO (First In, First Out)
‚úì Trazabilidad completa de cada transacci√≥n
‚úì Evidencia digital obligatoria para m√©todos no-efectivo
‚úì Compensaci√≥n autom√°tica para evitar mostrar simult√°neamente deuda y saldo


================================================================================
2. GLOSARIO DE T√âRMINOS
================================================================================

ENCARGADO:
  Padre, madre o responsable legal del estudiante. Es quien recibe la factura
  y realiza los pagos. M√∫ltiples estudiantes pueden compartir el mismo encargado.

CUENTA CORRIENTE:
  Cuenta contable individual por encargado o tutor. Registra todas las
  transacciones financieras de esa persona.

OBLIGACI√ìN:
  Lo que SE ESPERA cobrar o pagar. Se crea cuando:
  - Se marca una sesi√≥n como "dada" ‚Üí genera obligaci√≥n de cobro
  - Se completa una sesi√≥n con tutor ‚Üí genera obligaci√≥n de pago al tutor
  Estados: pendiente (sin aplicar), aplicado (completo), cancelado

PAGO:
  Lo que REALMENTE se recibi√≥ (entrada) o se pag√≥ (salida). 
  Direcciones: entrada (dinero que entra), salida (dinero que sale)
  Estados: pendiente (registrado), completado (con evidencia), 
           verificado (revisado por admin), cancelado (anulado)

APLICACI√ìN:
  V√≠nculo entre un pago y las obligaciones que cubre. Por ejemplo:
  - Encargado paga ‚Ç°15,000
  - Se aplica autom√°ticamente a las 2 primeras sesiones pendientes (‚Ç°7,500 c/u)

BALANCE NETO:
  Diferencia entre deuda pendiente y saldo a favor.
  F√≥rmula: balance_neto = deuda_pendiente - saldo_a_favor
  Si > 0: la persona DEBE dinero
  Si < 0: la persona TIENE saldo a su favor
  Si = 0: la cuenta est√° al d√≠a

ESTADO CONTABLE:
  Clasificaci√≥n del balance de una cuenta:
  - 'deuda': balance_neto > 0, debe pagar
  - 'saldo_favor': balance_neto < 0, tiene cr√©dito
  - 'al_dia': balance_neto = 0, sin pendientes

COMPENSACI√ìN AUTOM√ÅTICA:
  Proceso que evita mostrar simult√°neamente "Deuda: ‚Ç°7,500" y "Saldo: ‚Ç°7,500".
  El sistema calcula el balance neto y muestra SOLO UNO:
  - Si debe: muestra deuda, oculta saldo
  - Si tiene saldo: muestra saldo, oculta deuda
  - Si est√° al d√≠a: muestra ‚Ç°0

FIFO (First In, First Out):
  M√©todo de aplicaci√≥n de pagos. Cuando un encargado paga, el dinero se aplica
  primero a las obligaciones m√°s antiguas (por fecha de devengo).

BOLSA REAL:
  Efectivo f√≠sico en caja. Se calcula como:
  bolsa_real = total_ingresos - total_egresos
  Solo se cuentan pagos en estado 'completado' o 'verificado'

LIBRO DIARIO:
  Registro cronol√≥gico de todas las transacciones con debe/haber.
  Debe: dinero que entra (entrada)
  Haber: dinero que sale (salida)


================================================================================
3. MODELO DE BASE DE DATOS
================================================================================

--------------------------------------------------------------------------------
3.1. Tabla: encargados
--------------------------------------------------------------------------------

PROP√ìSITO:
  Almacena la informaci√≥n de contacto de los padres/responsables de estudiantes.
  Permite deduplicaci√≥n (un encargado puede tener m√∫ltiples estudiantes).

CAMPOS:
  id BIGSERIAL PRIMARY KEY
    ‚îî‚îÄ> Identificador √∫nico del encargado

  nombre TEXT
    ‚îî‚îÄ> Nombre completo del encargado
        Ejemplo: "Mar√≠a Gonz√°lez P√©rez"

  email TEXT
    ‚îî‚îÄ> Correo electr√≥nico (opcional)
        Ejemplo: "maria.gonzalez@gmail.com"

  telefono TEXT
    ‚îî‚îÄ> N√∫mero de tel√©fono (opcional)
        Ejemplo: "+506 8888-9999"

  email_norm TEXT GENERATED ALWAYS AS (lower(nullif(trim(email), ''))) STORED
    ‚îî‚îÄ> Email normalizado (lowercase, sin espacios)
        Usado para constraint UNIQUE y evitar duplicados

  telefono_norm TEXT GENERATED ALWAYS AS (nullif(trim(telefono), '')) STORED
    ‚îî‚îÄ> Tel√©fono normalizado (trimmed)
        Usado para constraint UNIQUE y evitar duplicados

  created_at TIMESTAMPTZ DEFAULT now()
    ‚îî‚îÄ> Fecha de creaci√≥n del registro

  updated_at TIMESTAMPTZ DEFAULT now()
    ‚îî‚îÄ> Fecha de √∫ltima actualizaci√≥n

CONSTRAINTS:
  - UNIQUE (email_norm): No puede haber dos encargados con el mismo email
  - UNIQUE (telefono_norm): No puede haber dos encargados con el mismo tel√©fono

√çNDICES:
  - idx_encargados_nombre ON (nombre)
    ‚îî‚îÄ> Para b√∫squedas por nombre

RELACIONES:
  estudiantes.encargado_id ‚Üí encargados.id
    ‚îî‚îÄ> Un encargado puede tener m√∫ltiples estudiantes
    ‚îî‚îÄ> Cuando se elimina el √∫ltimo estudiante, se elimina la cuenta de tesorer√≠a

EJEMPLO DE REGISTRO:
{
  "id": 1,
  "nombre": "Vanessa Arroyo Arce",
  "email": "vanessa@example.com",
  "telefono": "8888-1234",
  "email_norm": "vanessa@example.com",
  "telefono_norm": "8888-1234",
  "created_at": "2026-01-15T10:30:00Z",
  "updated_at": "2026-01-15T10:30:00Z"
}


--------------------------------------------------------------------------------
3.2. Tabla: tesoreria_cuentas_corrientes
--------------------------------------------------------------------------------

PROP√ìSITO:
  Cada encargado y cada tutor tiene UNA SOLA cuenta corriente.
  Esta es la entidad principal para toda la contabilidad.

CAMPOS:
  id BIGSERIAL PRIMARY KEY
    ‚îî‚îÄ> Identificador √∫nico de la cuenta

  tipo ENUM('encargado', 'tutor') NOT NULL
    ‚îî‚îÄ> Tipo de cuenta
        'encargado': cuenta de un padre/responsable (ellos PAGAN)
        'tutor': cuenta de un maestro (nosotros les PAGAMOS)

  encargado_id BIGINT REFERENCES encargados(id) ON DELETE RESTRICT
    ‚îî‚îÄ> ID del encargado (solo si tipo='encargado')
        RESTRICT: no se puede eliminar un encargado si tiene cuenta activa

  tutor_id BIGINT REFERENCES tutores(id) ON DELETE RESTRICT
    ‚îî‚îÄ> ID del tutor (solo si tipo='tutor')
        RESTRICT: no se puede eliminar un tutor si tiene cuenta activa

  created_at TIMESTAMPTZ DEFAULT now()
  updated_at TIMESTAMPTZ DEFAULT now()

CONSTRAINTS:
  tesoreria_cuentas_corrientes_ref_check:
    ‚îî‚îÄ> Si tipo='encargado': encargado_id NOT NULL, tutor_id NULL
    ‚îî‚îÄ> Si tipo='tutor': tutor_id NOT NULL, encargado_id NULL

√çNDICES √öNICOS:
  ux_tesoreria_cc_encargado ON (encargado_id) WHERE tipo='encargado'
    ‚îî‚îÄ> Garantiza UNA SOLA cuenta por encargado

  ux_tesoreria_cc_tutor ON (tutor_id) WHERE tipo='tutor'
    ‚îî‚îÄ> Garantiza UNA SOLA cuenta por tutor

BACKFILL AUTOM√ÅTICO:
  Al aplicar la migraci√≥n, se crean autom√°ticamente cuentas para:
  - Todos los encargados existentes
  - Todos los tutores existentes

EJEMPLO DE REGISTROS:
{
  "id": 101,
  "tipo": "encargado",
  "encargado_id": 1,
  "tutor_id": null,
  "created_at": "2026-01-15T10:30:00Z"
}
{
  "id": 201,
  "tipo": "tutor",
  "encargado_id": null,
  "tutor_id": 42,
  "created_at": "2026-01-15T10:30:00Z"
}


--------------------------------------------------------------------------------
3.3. Tabla: tesoreria_obligaciones
--------------------------------------------------------------------------------

PROP√ìSITO:
  Registra LO ESPERADO (lo que debemos cobrar o pagar).
  Cada sesi√≥n "dada" genera obligaciones:
    1) cobro_sesion: lo que el encargado debe pagar
    2) pago_tutor_sesion: lo que nosotros debemos pagar al tutor

CAMPOS:
  id BIGSERIAL PRIMARY KEY
    ‚îî‚îÄ> Identificador √∫nico de la obligaci√≥n

  tipo ENUM('cobro_sesion', 'pago_tutor_sesion', 'ajuste') NOT NULL
    ‚îî‚îÄ> Tipo de obligaci√≥n:
        'cobro_sesion': dinero que el encargado debe
        'pago_tutor_sesion': dinero que debemos al tutor
        'ajuste': ajustes manuales (descuentos, correcciones)

  cuenta_id BIGINT NOT NULL REFERENCES tesoreria_cuentas_corrientes(id)
    ‚îî‚îÄ> Cuenta a la que pertenece esta obligaci√≥n
        ON DELETE RESTRICT: no se puede eliminar una cuenta con obligaciones

  monto NUMERIC(12,2) NOT NULL CHECK (monto >= 0)
    ‚îî‚îÄ> Monto de la obligaci√≥n en colones
        Ejemplo: 7500.00 (‚Ç°7,500)

  fecha_devengo DATE NOT NULL
    ‚îî‚îÄ> Fecha en que se deveng√≥ la obligaci√≥n
        Ejemplo: "2026-02-17" (fecha de la sesi√≥n)
        Usado para ordenamiento FIFO

  estado TEXT NOT NULL DEFAULT 'pendiente'
    ‚îî‚îÄ> Estado de la obligaci√≥n:
        'pendiente': a√∫n no se ha aplicado ning√∫n pago
        'aplicado': completamente cubierta por aplicaciones
        'cancelado': obligaci√≥n anulada (no se cobra/paga)

  -- REFERENCIAS PARA TRAZABILIDAD --
  estudiante_id BIGINT REFERENCES estudiantes(id) ON DELETE SET NULL
  tutor_id BIGINT REFERENCES tutores(id) ON DELETE SET NULL
  curso_id BIGINT REFERENCES cursos(id) ON DELETE SET NULL
  matricula_id BIGINT REFERENCES matriculas(id) ON DELETE SET NULL
  sesion_id BIGINT REFERENCES sesiones_clases(id) ON DELETE SET NULL
    ‚îî‚îÄ> V√≠nculos con otras entidades para saber de d√≥nde viene la obligaci√≥n
        ON DELETE SET NULL: si se elimina la sesi√≥n, la obligaci√≥n queda hu√©rfana
        pero no se elimina (mantiene registro contable)

  detalle TEXT
    ‚îî‚îÄ> Descripci√≥n de la obligaci√≥n
        Ejemplo: "Cobro esperado por sesi√≥n (Curso de Ingl√©s A1)"

  created_at TIMESTAMPTZ DEFAULT now()
  updated_at TIMESTAMPTZ DEFAULT now()

CONSTRAINTS:
  CHECK (monto >= 0): el monto no puede ser negativo

√çNDICES √öNICOS (para idempotencia):
  ux_tesoreria_obligacion_cobro_sesion ON (sesion_id)
    WHERE tipo='cobro_sesion' AND sesion_id IS NOT NULL
    ‚îî‚îÄ> Evita duplicar el cobro de la misma sesi√≥n

  ux_tesoreria_obligacion_pago_tutor_sesion ON (sesion_id)
    WHERE tipo='pago_tutor_sesion' AND sesion_id IS NOT NULL
    ‚îî‚îÄ> Evita duplicar el pago al tutor por la misma sesi√≥n

√çNDICES REGULARES:
  idx_tesoreria_obligaciones_cuenta_fecha ON (cuenta_id, fecha_devengo)
    ‚îî‚îÄ> Para consultas FIFO (ordenar por fecha)

  idx_tesoreria_obligaciones_estado ON (estado)
    ‚îî‚îÄ> Para filtrar por estado

EJEMPLO DE REGISTROS:
-- Cobro al encargado:
{
  "id": 5001,
  "tipo": "cobro_sesion",
  "cuenta_id": 101,
  "monto": 7500.00,
  "fecha_devengo": "2026-02-17",
  "estado": "pendiente",
  "estudiante_id": 25,
  "tutor_id": 42,
  "curso_id": 3,
  "matricula_id": 88,
  "sesion_id": 1234,
  "detalle": "Cobro esperado por sesi√≥n (Ingl√©s A1)"
}

-- Pago al tutor:
{
  "id": 5002,
  "tipo": "pago_tutor_sesion",
  "cuenta_id": 201,
  "monto": 4500.00,
  "fecha_devengo": "2026-02-17",
  "estado": "pendiente",
  "estudiante_id": 25,
  "tutor_id": 42,
  "curso_id": 3,
  "matricula_id": 88,
  "sesion_id": 1234,
  "detalle": "Pago tutor esperado por sesi√≥n (Prof. Juan P√©rez)"
}


--------------------------------------------------------------------------------
3.4. Tabla: tesoreria_pagos
--------------------------------------------------------------------------------

PROP√ìSITO:
  Registra LO REAL (dinero que efectivamente entr√≥ o sali√≥).
  Cada pago debe tener evidencia digital (excepto efectivo).

CAMPOS:
  id BIGSERIAL PRIMARY KEY
    ‚îî‚îÄ> Identificador √∫nico del pago

  cuenta_id BIGINT NOT NULL REFERENCES tesoreria_cuentas_corrientes(id)
    ‚îî‚îÄ> Cuenta que realiz√≥/recibi√≥ el pago

  direccion ENUM('entrada', 'salida') NOT NULL
    ‚îî‚îÄ> Direcci√≥n del movimiento:
        'entrada': dinero que entra (encargado paga)
        'salida': dinero que sale (pagamos a tutor)

  monto NUMERIC(12,2) NOT NULL CHECK (monto > 0)
    ‚îî‚îÄ> Monto del pago (siempre positivo)
        Ejemplo: 15000.00 (‚Ç°15,000)

  fecha_pago DATE NOT NULL
    ‚îî‚îÄ> Fecha en que se realiz√≥ el pago
        Ejemplo: "2026-02-17"

  metodo TEXT
    ‚îî‚îÄ> M√©todo de pago:
        'efectivo', 'transferencia', 'sinpe', 'tarjeta', etc.

  referencia TEXT
    ‚îî‚îÄ> Referencia bancaria o n√∫mero de transacci√≥n
        Ejemplo: "SINPE-123456789"

  detalle TEXT
    ‚îî‚îÄ> Descripci√≥n adicional
        Ejemplo: "Pago de 2 sesiones de enero"

  -- EVIDENCIA DIGITAL (obligatoria para no-efectivo) --
  numero_comprobante TEXT
    ‚îî‚îÄ> N√∫mero del comprobante de pago
        Ejemplo: "COMP-2026-0234"

  fecha_comprobante DATE
    ‚îî‚îÄ> Fecha del comprobante

  comprobante_url TEXT
    ‚îî‚îÄ> URL del archivo adjunto (imagen/PDF)
        Ejemplo: "/uploads/tesoreria/comprobante_1234.pdf"

  estado ENUM('pendiente', 'completado', 'verificado', 'cancelado') NOT NULL
    ‚îî‚îÄ> Estado del pago:
        'pendiente': registrado, falta evidencia
        'completado': evidencia subida, listo para verificar
        'verificado': revisado y aprobado por admin
        'cancelado': pago anulado

  created_at TIMESTAMPTZ DEFAULT now()
  updated_at TIMESTAMPTZ DEFAULT now()

CONSTRAINTS:
  tesoreria_pagos_evidencia_check:
    ‚îî‚îÄ> Si m√©todo != 'efectivo' Y estado IN ('completado', 'verificado')
        ENTONCES numero_comprobante, fecha_comprobante, comprobante_url NOT NULL
        
        Traducci√≥n: Los pagos electr√≥nicos DEBEN tener evidencia completa
        para estar completados o verificados.

√çNDICES:
  idx_tesoreria_pagos_fecha ON (fecha_pago)
  idx_tesoreria_pagos_cuenta_fecha ON (cuenta_id, fecha_pago)
  idx_tesoreria_pagos_estado ON (estado)

EJEMPLO DE REGISTROS:
-- Pago en efectivo:
{
  "id": 3001,
  "cuenta_id": 101,
  "direccion": "entrada",
  "monto": 7500.00,
  "fecha_pago": "2026-02-17",
  "metodo": "efectivo",
  "referencia": null,
  "detalle": "Pago sesi√≥n 17/02",
  "numero_comprobante": null,
  "fecha_comprobante": null,
  "comprobante_url": null,
  "estado": "completado"
}

-- Pago por transferencia:
{
  "id": 3002,
  "cuenta_id": 101,
  "direccion": "entrada",
  "monto": 15000.00,
  "fecha_pago": "2026-02-17",
  "metodo": "sinpe",
  "referencia": "SINPE-987654321",
  "detalle": "SINPE M√≥vil desde cuenta *1234",
  "numero_comprobante": "COMP-2026-0234",
  "fecha_comprobante": "2026-02-17",
  "comprobante_url": "/uploads/tesoreria/sinpe_987654321.jpg",
  "estado": "verificado"
}


--------------------------------------------------------------------------------
3.5. Tabla: tesoreria_aplicaciones
--------------------------------------------------------------------------------

PROP√ìSITO:
  Vincula PAGOS con OBLIGACIONES.
  Cuando un encargado paga, ese dinero se aplica a sus obligaciones pendientes.

CAMPOS:
  id BIGSERIAL PRIMARY KEY
    ‚îî‚îÄ> Identificador √∫nico de la aplicaci√≥n

  pago_id BIGINT NOT NULL REFERENCES tesoreria_pagos(id) ON DELETE CASCADE
    ‚îî‚îÄ> Pago que se est√° aplicando
        CASCADE: si se elimina el pago, se eliminan sus aplicaciones

  obligacion_id BIGINT NOT NULL REFERENCES tesoreria_obligaciones(id)
    ‚îî‚îÄ> Obligaci√≥n que se est√° cubriendo
        ON DELETE RESTRICT: no se puede eliminar una obligaci√≥n aplicada

  monto NUMERIC(12,2) NOT NULL CHECK (monto > 0)
    ‚îî‚îÄ> Monto aplicado (puede ser parcial)
        Ejemplo: Si paga ‚Ç°10,000 y debe ‚Ç°15,000 en 2 sesiones de ‚Ç°7,500
        Se crea:
          - Aplicaci√≥n 1: ‚Ç°7,500 a sesi√≥n 1 (completa)
          - Aplicaci√≥n 2: ‚Ç°2,500 a sesi√≥n 2 (parcial)
        Quedar√≠a pendiente ‚Ç°5,000 en sesi√≥n 2

  created_at TIMESTAMPTZ DEFAULT now()

√çNDICES:
  idx_tesoreria_aplicaciones_pago ON (pago_id)
  idx_tesoreria_aplicaciones_obligacion ON (obligacion_id)

L√ìGICA FIFO (First In, First Out):
  Al crear un pago, el backend autom√°ticamente:
  1. Busca obligaciones pendientes de esa cuenta
  2. Las ordena por fecha_devengo ASC (m√°s antiguas primero)
  3. Aplica el monto del pago hasta cubrir o agotar el dinero

EJEMPLO DE APLICACI√ìN:
Situaci√≥n:
  - Encargado tiene 3 obligaciones:
    ‚Ä¢ Sesi√≥n 01/02: ‚Ç°7,500 (pendiente completo)
    ‚Ä¢ Sesi√≥n 08/02: ‚Ç°7,500 (pendiente completo)
    ‚Ä¢ Sesi√≥n 15/02: ‚Ç°7,500 (pendiente completo)
  - Encargado paga ‚Ç°15,000

Resultado:
{
  "pago_id": 3001,
  "aplicaciones": [
    {
      "id": 4001,
      "pago_id": 3001,
      "obligacion_id": 5001,
      "monto": 7500.00,  // Sesi√≥n 01/02 ‚Üí COMPLETA
      "created_at": "2026-02-17T14:30:00Z"
    },
    {
      "id": 4002,
      "pago_id": 3001,
      "obligacion_id": 5002,
      "monto": 7500.00,  // Sesi√≥n 08/02 ‚Üí COMPLETA
      "created_at": "2026-02-17T14:30:00Z"
    }
  ],
  "sobrante": 0,  // ‚Ç°15,000 - ‚Ç°7,500 - ‚Ç°7,500 = ‚Ç°0
  "sesion_15/02": "pendiente ‚Ç°7,500"  // A√∫n debe esta sesi√≥n
}


--------------------------------------------------------------------------------
3.6. Tabla: movimientos_dinero (LEGACY - Sistema Antiguo)
--------------------------------------------------------------------------------

PROP√ìSITO:
  Sistema ANTERIOR para cobros grupales (bulk).
  YA NO SE USA para sesiones individuales (eliminado para evitar duplicaci√≥n).

USO ACTUAL:
  SOLO para cobros grupales (estudiantes sin encargado individual).

CAMPOS:
  id BIGSERIAL PRIMARY KEY
  tipo TEXT ('ingreso' o 'egreso')
  monto NUMERIC
  fecha DATE
  metodo TEXT
  estado TEXT ('pendiente', 'completado')
  origen TEXT ('cobro_grupal', etc.)
  ...

MIGRACI√ìN A TESORER√çA V2:
  ‚úì Sesiones individuales: ahora usan tesoreria_obligaciones
  ‚úì Cobros grupales: siguen usando movimientos_dinero
  ‚úì Vista de saldos: YA NO suma movimientos_dinero (solo obligaciones)

NOTA IMPORTANTE:
  El endpoint POST /sesion/:matriculaId/:fecha/completar
  YA NO genera movimientos_dinero.
  Solo genera obligaciones en tesoreria_obligaciones.


================================================================================
4. VISTAS SQL Y C√ÅLCULOS AUTOM√ÅTICOS
================================================================================

Las vistas SQL son "tablas virtuales" que se calculan autom√°ticamente.
No almacenan datos, solo ejecutan queries en tiempo real.

--------------------------------------------------------------------------------
4.1. Vista: tesoreria_saldos_encargados_v1
--------------------------------------------------------------------------------

PROP√ìSITO:
  Calcula el saldo de cada encargado con COMPENSACI√ìN AUTOM√ÅTICA.
  Retorna: deuda, saldo a favor, balance neto y estado contable.

QUERY COMPLETA:
---------------
CREATE OR REPLACE VIEW public.tesoreria_saldos_encargados_v1 AS
WITH cc AS (
  -- Todas las cuentas de encargados
  SELECT id AS cuenta_id, encargado_id
  FROM public.tesoreria_cuentas_corrientes
  WHERE tipo='encargado'
),
ob AS (
  -- Total de obligaciones pendientes por cuenta
  SELECT
    o.cuenta_id,
    SUM(CASE WHEN o.estado = 'pendiente' THEN o.monto ELSE 0 END) AS obligado_pendiente
  FROM public.tesoreria_obligaciones o
  WHERE o.tipo='cobro_sesion'
  GROUP BY o.cuenta_id
),
app AS (
  -- Total aplicado a obligaciones por cuenta
  SELECT
    o.cuenta_id,
    SUM(a.monto) AS total_aplicado
  FROM public.tesoreria_aplicaciones a
  JOIN public.tesoreria_obligaciones o ON o.id = a.obligacion_id
  WHERE o.tipo='cobro_sesion' AND o.estado <> 'cancelado'
  GROUP BY o.cuenta_id
),
pagos AS (
  -- Total pagado (completado/verificado) por cuenta
  SELECT
    p.cuenta_id,
    SUM(CASE WHEN p.estado IN ('completado','verificado') AND p.direccion='entrada' 
        THEN p.monto ELSE 0 END) AS total_pagado
  FROM public.tesoreria_pagos p
  GROUP BY p.cuenta_id
),
balances AS (
  -- C√°lculo de balance neto
  SELECT
    cc.cuenta_id,
    cc.encargado_id,
    COALESCE(ob.obligado_pendiente, 0) AS deuda_pendiente_bruta,
    COALESCE(pagos.total_pagado, 0) - COALESCE(app.total_aplicado, 0) AS saldo_a_favor_bruto,
    -- F√ìRMULA CLAVE: balance_neto = deuda - saldo
    COALESCE(ob.obligado_pendiente, 0) - 
    (COALESCE(pagos.total_pagado, 0) - COALESCE(app.total_aplicado, 0)) AS balance_neto
  FROM cc
  LEFT JOIN ob ON ob.cuenta_id = cc.cuenta_id
  LEFT JOIN app ON app.cuenta_id = cc.cuenta_id
  LEFT JOIN pagos ON pagos.cuenta_id = cc.cuenta_id
)
SELECT
  encargado_id,
  cuenta_id,
  
  -- COMPENSACI√ìN AUTOM√ÅTICA:
  CASE 
    WHEN balance_neto > 0 THEN balance_neto  -- Debe dinero ‚Üí mostrar deuda
    ELSE 0                                    -- Tiene saldo ‚Üí deuda = 0
  END AS deuda_pendiente,
  
  CASE 
    WHEN balance_neto < 0 THEN ABS(balance_neto)  -- Tiene saldo ‚Üí mostrarlo
    ELSE 0                                         -- Debe dinero ‚Üí saldo = 0
  END AS saldo_a_favor,
  
  balance_neto,
  
  -- Estado contable
  CASE
    WHEN balance_neto > 0 THEN 'deuda'
    WHEN balance_neto < 0 THEN 'saldo_favor'
    ELSE 'al_dia'
  END AS estado
FROM balances;

COLUMNAS RETORNADAS:
--------------------
encargado_id BIGINT
  ‚îî‚îÄ> ID del encargado

cuenta_id BIGINT
  ‚îî‚îÄ> ID de la cuenta corriente

deuda_pendiente NUMERIC
  ‚îî‚îÄ> Dinero que el encargado debe
      Si balance_neto > 0: muestra el balance
      Si balance_neto <= 0: muestra 0 (ya no debe nada)

saldo_a_favor NUMERIC
  ‚îî‚îÄ> Dinero que el encargado tiene a su favor
      Si balance_neto < 0: muestra el saldo (valor absoluto)
      Si balance_neto >= 0: muestra 0 (no tiene saldo)

balance_neto NUMERIC
  ‚îî‚îÄ> Diferencia real: deuda - saldo
      > 0: debe dinero
      < 0: tiene saldo a favor
      = 0: est√° al d√≠a

estado TEXT
  ‚îî‚îÄ> 'deuda', 'saldo_favor', 'al_dia'

EJEMPLO PR√ÅCTICO:
-----------------
Situaci√≥n: Vanessa tiene:
  - Obligaciones pendientes: ‚Ç°7,500
  - Pagos completados: ‚Ç°7,500
  - Aplicaciones: ‚Ç°0 (no se han aplicado a√∫n)

C√°lculo:
  deuda_pendiente_bruta = 7500
  saldo_a_favor_bruto = 7500 - 0 = 7500
  balance_neto = 7500 - 7500 = 0

Resultado ANTES de compensaci√≥n (confuso):
  deuda_pendiente = 7500
  saldo_a_favor = 7500
  ‚ùå Usuario ve: "Debes ‚Ç°7,500 pero tienes ‚Ç°7,500" (confuso)

Resultado DESPU√âS de compensaci√≥n (correcto):
  deuda_pendiente = 0 (porque balance_neto = 0)
  saldo_a_favor = 0 (porque balance_neto = 0)
  balance_neto = 0
  estado = 'al_dia'
  ‚úÖ Usuario ve: "Cuenta al d√≠a ‚Ç°0" (claro)


--------------------------------------------------------------------------------
4.2. Vista: tesoreria_saldos_tutores_v1
--------------------------------------------------------------------------------

PROP√ìSITO:
  Calcula cu√°nto le debemos a cada tutor.

QUERY:
------
CREATE OR REPLACE VIEW public.tesoreria_saldos_tutores_v1 AS
WITH cc AS (
  SELECT id AS cuenta_id, tutor_id
  FROM public.tesoreria_cuentas_corrientes
  WHERE tipo='tutor'
),
ob AS (
  SELECT
    o.cuenta_id,
    SUM(CASE WHEN o.estado = 'pendiente' THEN o.monto ELSE 0 END) AS por_pagar
  FROM public.tesoreria_obligaciones o
  WHERE o.tipo='pago_tutor_sesion'
  GROUP BY o.cuenta_id
),
pagos AS (
  SELECT
    p.cuenta_id,
    SUM(CASE WHEN p.estado IN ('completado','verificado') AND p.direccion='salida' 
        THEN p.monto ELSE 0 END) AS pagado
  FROM public.tesoreria_pagos p
  GROUP BY p.cuenta_id
)
SELECT
  cc.tutor_id,
  cc.cuenta_id,
  COALESCE(ob.por_pagar, 0) AS por_pagar,
  COALESCE(pagos.pagado, 0) AS pagado
FROM cc
LEFT JOIN ob ON ob.cuenta_id = cc.cuenta_id
LEFT JOIN pagos ON pagos.cuenta_id = cc.cuenta_id;

COLUMNAS:
---------
tutor_id: ID del tutor
cuenta_id: ID de la cuenta corriente
por_pagar: Monto total pendiente de pagar
pagado: Monto ya pagado (completado/verificado)


--------------------------------------------------------------------------------
4.3. Vista: tesoreria_libro_diario_v1
--------------------------------------------------------------------------------

PROP√ìSITO:
  Muestra TODOS los pagos en formato de libro contable con debe/haber.

QUERY:
------
CREATE OR REPLACE VIEW public.tesoreria_libro_diario_v1 AS
SELECT
  p.id,
  p.fecha_pago,
  p.cuenta_id,
  cc.tipo AS cuenta_tipo,
  cc.encargado_id,
  cc.tutor_id,
  p.metodo,
  p.referencia,
  p.detalle,
  p.numero_comprobante,
  p.fecha_comprobante,
  p.comprobante_url,
  p.estado,
  
  -- Debe: dinero que entra
  CASE WHEN p.direccion = 'entrada' THEN p.monto ELSE 0 END AS debe,
  
  -- Haber: dinero que sale
  CASE WHEN p.direccion = 'salida' THEN p.monto ELSE 0 END AS haber,
  
  -- Neto del movimiento
  (CASE WHEN p.direccion = 'entrada' THEN p.monto ELSE -p.monto END) AS neto_mov,
  
  -- Saldo acumulado (running total)
  SUM(CASE WHEN p.direccion = 'entrada' THEN p.monto ELSE -p.monto END)
    OVER (ORDER BY p.fecha_pago, p.id) AS saldo_acumulado
FROM public.tesoreria_pagos p
JOIN public.tesoreria_cuentas_corrientes cc ON cc.id = p.cuenta_id;

COLUMNAS IMPORTANTES:
---------------------
debe: Dinero que entra (entrada = debe)
haber: Dinero que sale (salida = haber)
neto_mov: Entrada positiva, salida negativa
saldo_acumulado: Balance acumulado cronol√≥gicamente


================================================================================
5. FUNCIONES RPC (Remote Procedure Call)
================================================================================

Son funciones SQL que se llaman como procedimientos almacenados.

--------------------------------------------------------------------------------
5.1. tesoreria_get_or_create_cuenta_encargado_v1
--------------------------------------------------------------------------------

PROP√ìSITO:
  Obtiene o crea la cuenta corriente de un encargado.

FIRMA:
------
FUNCTION tesoreria_get_or_create_cuenta_encargado_v1(p_encargado_id BIGINT)
RETURNS BIGINT

L√ìGICA:
-------
1. Busca si ya existe cuenta para ese encargado_id
2. Si existe: retorna el cuenta_id
3. Si no existe: crea nueva cuenta y retorna su id

USO EN C√ìDIGO:
--------------
const { data: cuentaId } = await supabase.rpc(
  'tesoreria_get_or_create_cuenta_encargado_v1',
  { p_encargado_id: 123 }
);


--------------------------------------------------------------------------------
5.2. tesoreria_get_or_create_cuenta_tutor_v1
--------------------------------------------------------------------------------

Igual que la anterior pero para tutores.


================================================================================
6. API BACKEND - ENDPOINTS
================================================================================

Todos los endpoints est√°n en: backend/routes/tesoreria.js

--------------------------------------------------------------------------------
6.1. GET /tesoreria/encargados/resumen
--------------------------------------------------------------------------------

PROP√ìSITO:
  Lista todos los encargados con sus saldos (deuda, saldo a favor, balance neto).

FILTROS:
  Solo muestra encargados que:
  - Tienen al menos un estudiante activo, O
  - Tienen cuenta de tesorer√≠a con movimientos

QUERY SQL:
----------
SELECT 
  e.id AS encargado_id,
  e.nombre,
  e.email,
  e.telefono,
  s.cuenta_id,
  s.deuda_pendiente,
  s.saldo_a_favor,
  s.balance_neto,
  s.estado
FROM encargados e
LEFT JOIN tesoreria_saldos_encargados_v1 s ON s.encargado_id = e.id
WHERE (
  EXISTS (SELECT 1 FROM estudiantes WHERE encargado_id = e.id)
  OR s.cuenta_id IS NOT NULL
)

RESPONSE EJEMPLO:
-----------------
[
  {
    "cuenta_id": 101,
    "encargado_id": 1,
    "deuda_pendiente": 0,
    "saldo_a_favor": 0,
    "balance_neto": 0,
    "estado": "al_dia",
    "encargados": {
      "id": 1,
      "nombre": "Vanessa Arroyo Arce",
      "email": "vanessa@example.com",
      "telefono": "8888-1234"
    }
  },
  {
    "cuenta_id": 102,
    "encargado_id": 2,
    "deuda_pendiente": 15000,
    "saldo_a_favor": 0,
    "balance_neto": 15000,
    "estado": "deuda",
    "encargados": {
      "id": 2,
      "nombre": "Carlos Mart√≠nez",
      "email": null,
      "telefono": "7777-5555"
    }
  }
]


--------------------------------------------------------------------------------
6.2. GET /tesoreria/tutores/resumen
--------------------------------------------------------------------------------

PROP√ìSITO:
  Lista todos los tutores con lo que se les debe pagar.

RESPONSE EJEMPLO:
-----------------
[
  {
    "tutor_id": 42,
    "cuenta_id": 201,
    "por_pagar": 18000,
    "pagado": 9000,
    "tutores": {
      "id": 42,
      "nombre": "Prof. Juan P√©rez",
      "email": "juan.perez@example.com"
    }
  }
]


--------------------------------------------------------------------------------
6.3. GET /tesoreria/resumen
--------------------------------------------------------------------------------

PROP√ìSITO:
  Totales globales: deuda total, saldo total, por pagar a tutores.

QUERY L√ìGICA:
-------------
1. Suma deuda_pendiente de todos los encargados (vista)
2. Suma deuda de cobros grupales (movimientos_dinero legacy)
3. Suma saldo_a_favor de todos los encargados
4. Suma por_pagar de todos los tutores

RESPONSE EJEMPLO:
-----------------
{
  "deudaPendiente": 75000,
  "saldoAFavor": 12000,
  "porPagarTutores": 45000
}


--------------------------------------------------------------------------------
6.4. GET /tesoreria/bolsa
--------------------------------------------------------------------------------

PROP√ìSITO:
  Calcula el efectivo real en caja (ingresos - egresos).

QUERY L√ìGICA:
-------------
SELECT 
  SUM(CASE WHEN direccion='entrada' THEN monto ELSE 0 END) AS haber_real,
  SUM(CASE WHEN direccion='salida' THEN monto ELSE 0 END) AS debe_real,
  SUM(CASE WHEN direccion='entrada' THEN monto ELSE -monto END) AS bolsa_real
FROM tesoreria_pagos
WHERE estado IN ('completado', 'verificado')

RESPONSE EJEMPLO:
-----------------
{
  "haber_real": 150000,  // Total ingresado
  "debe_real": 45000,    // Total egresado
  "bolsa_real": 105000   // Neto en caja
}


--------------------------------------------------------------------------------
6.5. GET /tesoreria/diario
--------------------------------------------------------------------------------

PROP√ìSITO:
  Libro diario completo con filtros por fecha.

QUERY PARAMS:
-------------
?desde=2026-02-01&hasta=2026-02-28

RESPONSE:
---------
Retorna registros de tesoreria_libro_diario_v1 con joins a encargados/tutores.


--------------------------------------------------------------------------------
6.6. POST /tesoreria/encargados/:encargadoId/pagos
--------------------------------------------------------------------------------

PROP√ìSITO:
  Registrar un pago de un encargado.

REQUEST BODY:
-------------
{
  "monto": 15000,
  "fecha_pago": "2026-02-17",
  "metodo": "sinpe",
  "numero_comprobante": "COMP-2026-0234",
  "fecha_comprobante": "2026-02-17",
  "comprobante_url": "/uploads/tesoreria/sinpe_123.jpg",
  "referencia": "SINPE-987654321",
  "detalle": "Pago de 2 sesiones"
}

PROCESO:
--------
1. Obtiene o crea cuenta del encargado
2. Inserta registro en tesoreria_pagos con direccion='entrada'
3. Busca obligaciones pendientes (tipo='cobro_sesion') ordenadas por fecha_devengo ASC
4. Aplica el pago FIFO hasta agotar el monto o cubrir todas las obligaciones
5. Inserta registros en tesoreria_aplicaciones
6. Actualiza estado de obligaciones a 'aplicado' si quedaron completas
7. Si sobra dinero, queda como saldo_a_favor

RESPONSE:
---------
{
  "pago_id": 3001,
  "monto": 15000,
  "aplicaciones": [
    { "obligacion_id": 5001, "monto": 7500 },
    { "obligacion_id": 5002, "monto": 7500 }
  ],
  "monto_aplicado": 15000,
  "sobrante": 0
}


--------------------------------------------------------------------------------
6.7. POST /tesoreria/tutores/:tutorId/pagos
--------------------------------------------------------------------------------

PROP√ìSITO:
  Registrar pago a un tutor.

REQUEST BODY:
-------------
{
  "monto": 18000,
  "fecha_pago": "2026-02-17",
  "metodo": "transferencia",
  "numero_comprobante": "TRANS-456",
  "fecha_comprobante": "2026-02-17",
  "comprobante_url": "/uploads/tesoreria/trans_456.pdf",
  "funding_mode": "bolsa",  // o "encargado"
  "source_encargado_id": null,
  "obligacion_ids": [6001, 6002, 6003]
}

PROCESO:
--------
1. Obtiene cuenta del tutor
2. Si funding_mode='bolsa': el dinero sale de la bolsa com√∫n
3. Si funding_mode='encargado': el dinero sale del saldo a favor del encargado
4. Inserta pago con direccion='salida'
5. Aplica a las obligaciones especificadas en obligacion_ids


--------------------------------------------------------------------------------
6.8. POST /tesoreria/pagos/:pagoId/comprobante
--------------------------------------------------------------------------------

PROP√ìSITO:
  Subir archivo de comprobante (imagen/PDF) para un pago.

REQUEST:
--------
Content-Type: multipart/form-data
file: [archivo adjunto]

PROCESO:
--------
1. Guarda archivo en uploads/tesoreria/
2. Actualiza tesoreria_pagos.comprobante_url
3. Cambia estado a 'completado'


--------------------------------------------------------------------------------
6.9. POST /tesoreria/grupos/:grupoId/cobro
--------------------------------------------------------------------------------

PROP√ìSITO:
  Registrar cobro grupal (estudiantes sin encargado individual).

NOTA:
  Este endpoint TODAV√çA usa movimientos_dinero (sistema legacy).


================================================================================
7. FLUJOS COMPLETOS DEL SISTEMA
================================================================================

--------------------------------------------------------------------------------
7.1. Flujo: Marcar sesi√≥n como dada
--------------------------------------------------------------------------------

ACTOR: Administrador o Tutor
URL: POST /sesion/:matriculaId/:fecha/completar
ARCHIVO: backend/routes/dashboard.js

PASOS:
------
1. Usuario marca sesi√≥n como "dada" en el calendario
   
2. Backend valida:
   - Matricula existe
   - Fecha no es futura
   - No hay sesi√≥n ya marcada para esa fecha

3. Backend obtiene datos:
   - Costo del curso (costo_curso)
   - Pago al tutor (pago_tutor)
   - Encargado de la matr√≠cula

4. Backend llama a ensureTesoreriaObligacionesV2(sesion.id):

   a) Crear obligaci√≥n de COBRO al encargado:
      - Busca/crea cuenta corriente del encargado
      - INSERT INTO tesoreria_obligaciones:
        {
          tipo: 'cobro_sesion',
          cuenta_id: [cuenta del encargado],
          monto: [costo_curso],
          fecha_devengo: [fecha de la sesi√≥n],
          estado: 'pendiente',
          sesion_id: [id de la sesi√≥n],
          detalle: "Cobro esperado por sesi√≥n (Nombre del curso)"
        }

   b) Crear obligaci√≥n de PAGO al tutor (si hay tutor):
      - Busca/crea cuenta corriente del tutor
      - INSERT INTO tesoreria_obligaciones:
        {
          tipo: 'pago_tutor_sesion',
          cuenta_id: [cuenta del tutor],
          monto: [pago_tutor],
          fecha_devengo: [fecha de la sesi√≥n],
          estado: 'pendiente',
          sesion_id: [id de la sesi√≥n],
          detalle: "Pago tutor esperado por sesi√≥n (Nombre tutor)"
        }

5. Si el curso es tipo_pago='mensual':
   - NO se generan obligaciones inmediatas
   - Se generan al final del mes (otro proceso)

6. Si hay duplicados (constraint ux_tesoreria_obligacion_cobro_sesion):
   - Se ignoran silenciosamente (idempotencia)

7. Response 200 OK con sesion_id

RESULTADO EN BD:
----------------
- 1 registro nuevo en sesiones_clases
- 1 registro nuevo en tesoreria_obligaciones (cobro al encargado)
- 1 registro nuevo en tesoreria_obligaciones (pago al tutor)
- 0 registros en movimientos_dinero (YA NO SE USA)

EFECTO EN VISTA:
----------------
SELECT * FROM tesoreria_saldos_encargados_v1 WHERE encargado_id = X;
  deuda_pendiente: +7500 (aumenta la deuda)
  saldo_a_favor: sin cambios
  balance_neto: +7500 (debe m√°s dinero)
  estado: 'deuda'


--------------------------------------------------------------------------------
7.2. Flujo: Encargado realiza un pago
--------------------------------------------------------------------------------

ACTOR: Encargado (padre/responsable)
URL: POST /tesoreria/encargados/:encargadoId/pagos
ARCHIVO: backend/routes/tesoreria.js

PASOS:
------
1. Encargado paga (efectivo, SINPE, transferencia, etc.)

2. Admin registra el pago en el sistema con datos:
   {
     "monto": 15000,
     "fecha_pago": "2026-02-17",
     "metodo": "sinpe",
     "referencia": "SINPE-123456",
     "detalle": "Pago de 2 sesiones"
   }

3. Backend llama a registrarPagoEncargadoV1():

   a) Obtiene o crea cuenta corriente del encargado
   
   b) INSERT INTO tesoreria_pagos:
      {
        cuenta_id: [cuenta del encargado],
        direccion: 'entrada',
        monto: 15000,
        fecha_pago: '2026-02-17',
        metodo: 'sinpe',
        referencia: 'SINPE-123456',
        estado: 'pendiente',  // Si falta evidencia
        ...
      }

   c) Si metodo != 'efectivo' Y hay comprobante:
      - estado = 'completado'
      - Requiere numero_comprobante, fecha_comprobante, comprobante_url

4. Backend aplica el pago AUTOM√ÅTICAMENTE (FIFO):

   a) SELECT obligaciones WHERE:
      - cuenta_id = [cuenta del encargado]
      - tipo = 'cobro_sesion'
      - estado = 'pendiente'
      ORDER BY fecha_devengo ASC

   b) Recorre obligaciones en orden cronol√≥gico:
   
      Ejemplo:
      - Obligaci√≥n 1 (01/02): ‚Ç°7,500 pendientes
      - Obligaci√≥n 2 (08/02): ‚Ç°7,500 pendientes
      - Obligaci√≥n 3 (15/02): ‚Ç°7,500 pendientes
      
      Pago = ‚Ç°15,000
      
      Paso 1: Aplicar ‚Ç°7,500 a Obligaci√≥n 1
        ‚Üí INSERT INTO tesoreria_aplicaciones (pago_id, obligacion_id, monto: 7500)
        ‚Üí UPDATE tesoreria_obligaciones SET estado='aplicado' WHERE id=1
        ‚Üí Restante: ‚Ç°15,000 - ‚Ç°7,500 = ‚Ç°7,500
      
      Paso 2: Aplicar ‚Ç°7,500 a Obligaci√≥n 2
        ‚Üí INSERT INTO tesoreria_aplicaciones (pago_id, obligacion_id, monto: 7500)
        ‚Üí UPDATE tesoreria_obligaciones SET estado='aplicado' WHERE id=2
        ‚Üí Restante: ‚Ç°7,500 - ‚Ç°7,500 = ‚Ç°0
      
      Paso 3: No hay m√°s dinero, se detiene
        ‚Üí Obligaci√≥n 3 queda pendiente: ‚Ç°7,500

5. Si sobrara dinero (por ejemplo, pag√≥ ‚Ç°20,000):
   - Se aplicar√≠an las 3 obligaciones (‚Ç°22,500)
   - No alcanza para todas, se aplica parcialmente
   - O si no tiene m√°s obligaciones, queda como saldo_a_favor

6. Response 201 con detalles de aplicaciones

RESULTADO EN BD:
----------------
- 1 registro nuevo en tesoreria_pagos
- 2 registros nuevos en tesoreria_aplicaciones
- 2 registros actualizados en tesoreria_obligaciones (estado='aplicado')

EFECTO EN VISTA:
----------------
SELECT * FROM tesoreria_saldos_encargados_v1 WHERE encargado_id = X;

ANTES:
  deuda_pendiente: 22500 (3 sesiones √ó 7500)
  saldo_a_favor: 0
  balance_neto: 22500
  estado: 'deuda'

DESPU√âS (pag√≥ ‚Ç°15,000):
  deuda_pendiente: 7500 (solo 1 sesi√≥n pendiente)
  saldo_a_favor: 0
  balance_neto: 7500
  estado: 'deuda'

C√ÅLCULO INTERNO:
  obligado_pendiente = 7500 (solo Obligaci√≥n 3)
  total_pagado = 15000
  total_aplicado = 15000
  saldo_a_favor_bruto = 15000 - 15000 = 0
  balance_neto = 7500 - 0 = 7500


--------------------------------------------------------------------------------
7.3. Flujo: Aplicaci√≥n autom√°tica FIFO
--------------------------------------------------------------------------------

REGLA:
  Los pagos se aplican SIEMPRE a las obligaciones m√°s antiguas primero.

ALGORITMO:
----------
funci√≥n aplicarPagoFIFO(pago_id, cuenta_id, monto_disponible):
  
  // 1. Obtener obligaciones pendientes ordenadas por fecha
  obligaciones = SELECT * FROM tesoreria_obligaciones
    WHERE cuenta_id = cuenta_id
      AND tipo = 'cobro_sesion'
      AND estado = 'pendiente'
    ORDER BY fecha_devengo ASC, id ASC

  monto_restante = monto_disponible
  aplicaciones = []

  // 2. Iterar sobre obligaciones
  para cada obligacion en obligaciones:
    
    // Calcular cu√°nto falta por cubrir de esta obligaci√≥n
    total_aplicado_previa = SUM(monto) FROM tesoreria_aplicaciones 
      WHERE obligacion_id = obligacion.id
    
    pendiente_obligacion = obligacion.monto - total_aplicado_previa
    
    si pendiente_obligacion <= 0:
      continuar  // Ya est√° cubierta, saltar
    
    // Calcular cu√°nto aplicar
    monto_a_aplicar = MIN(monto_restante, pendiente_obligacion)
    
    // Crear aplicaci√≥n
    INSERT INTO tesoreria_aplicaciones (pago_id, obligacion_id, monto)
      VALUES (pago_id, obligacion.id, monto_a_aplicar)
    
    aplicaciones.agregar({
      obligacion_id: obligacion.id,
      monto: monto_a_aplicar
    })
    
    // Reducir restante
    monto_restante -= monto_a_aplicar
    
    // Verificar si qued√≥ completa
    nuevo_total_aplicado = total_aplicado_previa + monto_a_aplicar
    si nuevo_total_aplicado >= obligacion.monto:
      UPDATE tesoreria_obligaciones SET estado='aplicado' WHERE id=obligacion.id
    
    // Si ya no queda dinero, terminar
    si monto_restante <= 0:
      romper ciclo
  
  retornar {
    aplicaciones: aplicaciones,
    monto_aplicado: monto_disponible - monto_restante,
    sobrante: monto_restante
  }

EJEMPLO VISUAL:
---------------
Timeline de obligaciones:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 01/02  08/02  15/02  22/02  01/03                           ‚îÇ
‚îÇ ‚Ç°7,500 ‚Ç°7,500 ‚Ç°7,500 ‚Ç°7,500 ‚Ç°7,500  (5 sesiones pendientes) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Pago: ‚Ç°18,000

Aplicaci√≥n FIFO:
  ‚ñº
01/02 ‚Üí ‚Ç°7,500 aplicados ‚Üí COMPLETA ‚úÖ
  ‚ñº
08/02 ‚Üí ‚Ç°7,500 aplicados ‚Üí COMPLETA ‚úÖ
  ‚ñº
15/02 ‚Üí ‚Ç°3,000 aplicados ‚Üí PARCIAL üü° (faltan ‚Ç°4,500)
  
Quedan pendientes:
  15/02: ‚Ç°4,500
  22/02: ‚Ç°7,500
  01/03: ‚Ç°7,500


--------------------------------------------------------------------------------
7.4. Flujo: Pago a tutor
--------------------------------------------------------------------------------

ACTOR: Administrador
URL: POST /tesoreria/tutores/:tutorId/pagos

CASO 1: Pago desde la bolsa com√∫n
-----------------------------------
{
  "monto": 18000,
  "fecha_pago": "2026-02-17",
  "metodo": "transferencia",
  "funding_mode": "bolsa",
  "obligacion_ids": [6001, 6002, 6003]
}

PROCESO:
1. Valida que hay suficiente en bolsa_real
2. INSERT INTO tesoreria_pagos (direccion='salida')
3. Aplica a las obligaciones especificadas
4. Reduce la bolsa_real

CASO 2: Pago desde saldo a favor de un encargado
-------------------------------------------------
{
  "monto": 18000,
  "fecha_pago": "2026-02-17",
  "metodo": "transferencia_interna",
  "funding_mode": "encargado",
  "source_encargado_id": 123,
  "obligacion_ids": [6001, 6002]
}

PROCESO:
1. Valida que el encargado tiene suficiente saldo_a_favor
2. INSERT INTO tesoreria_pagos en cuenta del tutor (salida)
3. Si es transferencia interna, tambi√©n registra salida en cuenta del encargado
4. Aplica a obligaciones del tutor


--------------------------------------------------------------------------------
7.5. Flujo: Cobro grupal (bulk)
--------------------------------------------------------------------------------

PROP√ìSITO:
  Para estudiantes sin encargado individual (eventos, talleres grupales).

URL: POST /tesoreria/grupos/:grupoId/cobro

PROCESO:
1. Obtiene lista de estudiantes del grupo
2. Para cada estudiante SIN encargado_id:
   - INSERT INTO movimientos_dinero (tipo='ingreso', origen='cobro_grupal')
3. NO genera obligaciones en tesoreria_obligaciones

NOTA:
  Este es el √öNICO uso actual de movimientos_dinero.
  Los cobros grupales NO se integran con el sistema v2 a√∫n.


================================================================================
8. SISTEMA DE COMPENSACI√ìN AUTOM√ÅTICA
================================================================================

--------------------------------------------------------------------------------
8.1. Problema identificado
--------------------------------------------------------------------------------

ANTES (sin compensaci√≥n):
-------------------------
Usuario: Vanessa Arroyo Arce
  - Debe 1 sesi√≥n: ‚Ç°7,500
  - Ha pagado: ‚Ç°7,500
  - El pago NO ha sido aplicado a√∫n

Vista en pantalla:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ üî¥ Deuda pendiente: ‚Ç°7,500            ‚îÇ
  ‚îÇ üü¢ Saldo a favor: ‚Ç°7,500              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚ùå PROBLEMA:
  - Confunde al usuario: ¬ødebo o no debo?
  - Viola principio contable: activos y pasivos deben compensar
  - Matem√°ticamente: ‚Ç°7,500 - ‚Ç°7,500 = ‚Ç°0
  - UI muestra ‚Ç°15,000 en total (enga√±oso)


--------------------------------------------------------------------------------
8.2. Soluci√≥n implementada
--------------------------------------------------------------------------------

DESPU√âS (con compensaci√≥n):
---------------------------
Misma situaci√≥n: deuda ‚Ç°7,500, abon√≥ ‚Ç°7,500

Vista en pantalla:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ ‚úÖ Cuenta al d√≠a: ‚Ç°0                  ‚îÇ
  ‚îÇ Sin pagos pendientes                   ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚úÖ SOLUCI√ìN:
  - Claro e inequ√≠voco
  - Refleja realidad contable
  - Usuario entiende inmediatamente
  - NUNCA muestra deuda y saldo simult√°neamente


--------------------------------------------------------------------------------
8.3. F√≥rmula de balance neto
--------------------------------------------------------------------------------

balance_neto = deuda_pendiente - saldo_a_favor

Donde:
  deuda_pendiente = SUM(obligaciones.monto) WHERE estado='pendiente'
  saldo_a_favor = total_pagado - total_aplicado

total_pagado = SUM(pagos.monto) WHERE direccion='entrada' AND estado IN ('completado','verificado')
total_aplicado = SUM(aplicaciones.monto)

INTERPRETACI√ìN:
  balance_neto > 0  ‚Üí La persona DEBE dinero
  balance_neto < 0  ‚Üí La persona TIENE saldo a favor
  balance_neto = 0  ‚Üí La cuenta est√° AL D√çA


--------------------------------------------------------------------------------
8.4. Estados contables
--------------------------------------------------------------------------------

El sistema define 3 estados mutuamente excluyentes:

1. 'deuda':
   - Condici√≥n: balance_neto > 0
   - Interpretaci√≥n: La persona debe pagar
   - UI: Tarjeta roja üî¥
   - Muestra: deuda_pendiente = balance_neto, saldo_a_favor = 0
   - Acci√≥n: Bot√≥n "Pagar"

2. 'saldo_favor':
   - Condici√≥n: balance_neto < 0
   - Interpretaci√≥n: La persona tiene cr√©dito
   - UI: Tarjeta verde üü¢
   - Muestra: saldo_a_favor = ABS(balance_neto), deuda_pendiente = 0
   - Mensaje: "Disponible para aplicar"

3. 'al_dia':
   - Condici√≥n: balance_neto = 0
   - Interpretaci√≥n: Sin pendientes
   - UI: Tarjeta azul ‚úÖ
   - Muestra: ambos = 0
   - Mensaje: "Sin pagos pendientes"


--------------------------------------------------------------------------------
8.5. L√≥gica en SQL (Vista)
--------------------------------------------------------------------------------

Ver secci√≥n 4.1 para el SQL completo.

EXTRACTO CLAVE:
---------------
SELECT
  CASE 
    WHEN balance_neto > 0 THEN balance_neto
    ELSE 0
  END AS deuda_pendiente,
  
  CASE 
    WHEN balance_neto < 0 THEN ABS(balance_neto)
    ELSE 0
  END AS saldo_a_favor,
  
  balance_neto,
  
  CASE
    WHEN balance_neto > 0 THEN 'deuda'
    WHEN balance_neto < 0 THEN 'saldo_favor'
    ELSE 'al_dia'
  END AS estado
FROM balances;


--------------------------------------------------------------------------------
8.6. L√≥gica en Backend (API)
--------------------------------------------------------------------------------

ARCHIVO: backend/routes/tesoreria.js
ENDPOINT: GET /encargados/resumen

C√ìDIGO:
-------
const { data: saldos } = await supabase
  .from('tesoreria_saldos_encargados_v1')
  .select('cuenta_id, encargado_id, deuda_pendiente, saldo_a_favor, balance_neto, estado');

const resultado = saldos.map(saldo => ({
  cuenta_id: saldo.cuenta_id,
  encargado_id: saldo.encargado_id,
  deuda_pendiente: Number(saldo.deuda_pendiente) || 0,
  saldo_a_favor: Number(saldo.saldo_a_favor) || 0,
  balance_neto: Number(saldo.balance_neto) || 0,
  estado: saldo.estado || 'al_dia',
  encargados: { ... }
}));

return res.json(resultado);

El backend NO hace c√°lculos, solo pasa los datos de la vista.


--------------------------------------------------------------------------------
8.7. L√≥gica en Frontend (React)
--------------------------------------------------------------------------------

ARCHIVO: LInguistika-Studio/views/Tesoreria.tsx

TYPE DEFINITION:
----------------
type EncargadoResumenItem = {
  cuenta_id: number;
  encargado_id: number;
  deuda_pendiente: number;
  saldo_a_favor: number;
  balance_neto: number;
  estado: 'deuda' | 'saldo_favor' | 'al_dia';
  encargados?: { ... } | null;
};

UI COMPONENT:
-------------
<div className={`rounded-2xl border p-4 ${
  estado === 'deuda' ? 'border-red-500/30 bg-red-500/5' :
  estado === 'saldo_favor' ? 'border-green-500/30 bg-green-500/5' :
  'border-blue-500/30 bg-blue-500/5'
}`}>
  
  {estado === 'deuda' && (
    <>
      <div className="text-sm text-red-300">üî¥ Deuda pendiente</div>
      <div className="text-3xl font-black text-red-400">
        {formatCRC(deuda_pendiente)}
      </div>
      <Button onClick={openPago} variant="destructive">
        Pagar
      </Button>
    </>
  )}
  
  {estado === 'saldo_favor' && (
    <>
      <div className="text-sm text-green-300">üü¢ Saldo a favor</div>
      <div className="text-3xl font-black text-green-400">
        {formatCRC(saldo_a_favor)}
      </div>
      <div className="text-xs text-green-200 mt-2">
        Disponible para aplicar
      </div>
    </>
  )}
  
  {estado === 'al_dia' && (
    <>
      <div className="text-sm text-blue-300">‚úÖ Cuenta al d√≠a</div>
      <div className="text-3xl font-black text-blue-400">
        {formatCRC(0)}
      </div>
      <div className="text-xs text-blue-200 mt-2">
        Sin pagos pendientes
      </div>
    </>
  )}
</div>

NOTA CR√çTICA:
  NUNCA se renderizan ambas tarjetas (deuda y saldo) simult√°neamente.
  Es mutuamente excluyente basado en el estado.


================================================================================
9. CASOS DE USO Y EJEMPLOS PR√ÅCTICOS
================================================================================

--------------------------------------------------------------------------------
CASO 1: Usuario nuevo sin actividad
--------------------------------------------------------------------------------

Estado inicial:
  - Sin obligaciones
  - Sin pagos
  - cuenta_id: 101

Vista SQL:
  deuda_pendiente: 0
  saldo_a_favor: 0
  balance_neto: 0
  estado: 'al_dia'

UI Frontend:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ ‚úÖ Cuenta al d√≠a         ‚îÇ
  ‚îÇ ‚Ç°0                       ‚îÇ
  ‚îÇ Sin pagos pendientes     ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò


--------------------------------------------------------------------------------
CASO 2: Usuario con 2 sesiones dadas, sin pagos
--------------------------------------------------------------------------------

Obligaciones:
  - Sesi√≥n 01/02: ‚Ç°7,500 (pendiente)
  - Sesi√≥n 08/02: ‚Ç°7,500 (pendiente)

Pagos:
  - Ninguno

Vista SQL:
  deuda_pendiente: 15000
  saldo_a_favor: 0
  balance_neto: 15000
  estado: 'deuda'

UI Frontend:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ üî¥ Deuda pendiente       ‚îÇ
  ‚îÇ ‚Ç°15,000                  ‚îÇ
  ‚îÇ [Bot√≥n: Pagar]           ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò


--------------------------------------------------------------------------------
CASO 3: Usuario pag√≥ menos de lo que debe
--------------------------------------------------------------------------------

Obligaciones:
  - Sesi√≥n 01/02: ‚Ç°7,500 (aplicado)
  - Sesi√≥n 08/02: ‚Ç°7,500 (parcial: ‚Ç°2,500 aplicados)
  - Sesi√≥n 15/02: ‚Ç°7,500 (pendiente)

Pagos:
  - Pago 1: ‚Ç°10,000 (completado)

Aplicaciones:
  - ‚Ç°7,500 a Sesi√≥n 01/02
  - ‚Ç°2,500 a Sesi√≥n 08/02

C√°lculo:
  obligado_pendiente = 0 + 5000 + 7500 = 12500
  total_pagado = 10000
  total_aplicado = 10000
  saldo_a_favor_bruto = 10000 - 10000 = 0
  balance_neto = 12500 - 0 = 12500

Vista SQL:
  deuda_pendiente: 12500
  saldo_a_favor: 0
  balance_neto: 12500
  estado: 'deuda'

UI Frontend:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ üî¥ Deuda pendiente       ‚îÇ
  ‚îÇ ‚Ç°12,500                  ‚îÇ
  ‚îÇ [Bot√≥n: Pagar]           ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò


--------------------------------------------------------------------------------
CASO 4: Usuario pag√≥ exactamente lo que debe (Vanessa)
--------------------------------------------------------------------------------

Obligaciones:
  - Sesi√≥n 01/02: ‚Ç°7,500 (pendiente, no aplicado a√∫n)

Pagos:
  - Pago 1: ‚Ç°7,500 (completado, pero no aplicado manualmente)

Aplicaciones:
  - Ninguna (pago registrado pero no procesado por FIFO)

C√°lculo:
  obligado_pendiente = 7500
  total_pagado = 7500
  total_aplicado = 0
  saldo_a_favor_bruto = 7500 - 0 = 7500
  balance_neto = 7500 - 7500 = 0

Vista SQL:
  deuda_pendiente: 0  ‚Üê Compensaci√≥n autom√°tica
  saldo_a_favor: 0    ‚Üê Compensaci√≥n autom√°tica
  balance_neto: 0
  estado: 'al_dia'

UI Frontend:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ ‚úÖ Cuenta al d√≠a         ‚îÇ
  ‚îÇ ‚Ç°0                       ‚îÇ
  ‚îÇ Sin pagos pendientes     ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üéØ Este es el caso que motiv√≥ la implementaci√≥n de compensaci√≥n.
   ANTES mostraba ‚Ç°7,500 deuda + ‚Ç°7,500 saldo (confuso)
   AHORA muestra ‚Ç°0 (correcto)


--------------------------------------------------------------------------------
CASO 5: Usuario pag√≥ M√ÅS de lo que debe
--------------------------------------------------------------------------------

Obligaciones:
  - Sesi√≥n 01/02: ‚Ç°7,500 (aplicado)
  - Sesi√≥n 08/02: ‚Ç°7,500 (aplicado)

Pagos:
  - Pago 1: ‚Ç°20,000 (completado)

Aplicaciones:
  - ‚Ç°7,500 a Sesi√≥n 01/02
  - ‚Ç°7,500 a Sesi√≥n 08/02
  - Sobran: ‚Ç°5,000

C√°lculo:
  obligado_pendiente = 0
  total_pagado = 20000
  total_aplicado = 15000
  saldo_a_favor_bruto = 20000 - 15000 = 5000
  balance_neto = 0 - 5000 = -5000

Vista SQL:
  deuda_pendiente: 0
  saldo_a_favor: 5000  ‚Üê ABS(-5000)
  balance_neto: -5000
  estado: 'saldo_favor'

UI Frontend:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ üü¢ Saldo a favor                ‚îÇ
  ‚îÇ ‚Ç°5,000                          ‚îÇ
  ‚îÇ Disponible para aplicar         ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò


--------------------------------------------------------------------------------
CASO 6: Usuario con deuda, luego paga, genera nueva deuda
--------------------------------------------------------------------------------

Timeline:
01/02: Sesi√≥n 1 marcada ‚Üí obligaci√≥n ‚Ç°7,500
05/02: Paga ‚Ç°7,500 ‚Üí aplicaci√≥n completa
10/02: Sesi√≥n 2 marcada ‚Üí obligaci√≥n ‚Ç°7,500
15/02: Sesi√≥n 3 marcada ‚Üí obligaci√≥n ‚Ç°7,500
17/02: Consulta saldo

Obligaciones:
  - Sesi√≥n 1: ‚Ç°7,500 (aplicado)
  - Sesi√≥n 2: ‚Ç°7,500 (pendiente)
  - Sesi√≥n 3: ‚Ç°7,500 (pendiente)

Pagos:
  - Pago 1: ‚Ç°7,500 (completado)

Aplicaciones:
  - ‚Ç°7,500 a Sesi√≥n 1

C√°lculo:
  obligado_pendiente = 0 + 7500 + 7500 = 15000
  total_pagado = 7500
  total_aplicado = 7500
  saldo_a_favor_bruto = 7500 - 7500 = 0
  balance_neto = 15000 - 0 = 15000

Vista SQL:
  deuda_pendiente: 15000
  saldo_a_favor: 0
  balance_neto: 15000
  estado: 'deuda'


================================================================================
10. REGLAS DE NEGOCIO
================================================================================

1. IDEMPOTENCIA:
   - No se puede cobrar dos veces la misma sesi√≥n
   - Constraint: ux_tesoreria_obligacion_cobro_sesion ON (sesion_id)

2. EVIDENCIA OBLIGATORIA:
   - Pagos no-efectivo requieren: numero_comprobante, fecha_comprobante, comprobante_url
   - Constraint: tesoreria_pagos_evidencia_check

3. APLICACI√ìN AUTOM√ÅTICA:
   - Los pagos se aplican SIEMPRE en orden FIFO (fecha_devengo ASC)
   - No es configurable por el usuario

4. COMPENSACI√ìN AUTOM√ÅTICA:
   - NUNCA se muestra deuda y saldo simult√°neamente
   - El balance_neto determina el estado
   - La UI muestra UNA SOLA tarjeta

5. ELIMINACI√ìN DE ESTUDIANTES:
   - Si se elimina el √∫ltimo estudiante de un encargado:
     * Se elimina la cuenta de tesorer√≠a (si no tiene movimientos)
   - Si tiene movimientos, se mantiene la cuenta

6. ESTADOS DE PAGO:
   - 'pendiente': Registrado, puede faltar evidencia
   - 'completado': Evidencia completa, listo para verificar
   - 'verificado': Revisado y aprobado por admin
   - 'cancelado': Anulado (no se cuenta en bolsa ni aplicaciones)

7. ESTADOS DE OBLIGACI√ìN:
   - 'pendiente': A√∫n no cubierta completamente
   - 'aplicado': Cubierta por aplicaciones
   - 'cancelado': Anulada (no se cobra)

8. CUENTA POR ENTIDAD:
   - UNA SOLA cuenta por encargado
   - UNA SOLA cuenta por tutor
   - Constraint: ux_tesoreria_cc_encargado, ux_tesoreria_cc_tutor

9. MONTOS POSITIVOS:
   - tesoreria_obligaciones.monto >= 0
   - tesoreria_pagos.monto > 0
   - tesoreria_aplicaciones.monto > 0

10. INTEGRIDAD REFERENCIAL:
    - No se pueden eliminar encargados/tutores con cuentas activas (RESTRICT)
    - Si se elimina un pago, se eliminan sus aplicaciones (CASCADE)
    - Si se elimina una sesi√≥n, las obligaciones quedan hu√©rfanas (SET NULL)


================================================================================
11. FRONTEND - COMPONENTES Y UI
================================================================================

ARCHIVO PRINCIPAL:
  LInguistika-Studio/views/Tesoreria.tsx

SECCIONES:
----------
1. Encargados (lista con saldos)
2. Tutores (lista con montos por pagar)
3. Libro Diario (transacciones cronol√≥gicas)
4. Bolsa Real (efectivo en caja)
5. Totales R√°pidos (resumen global)

COMPONENTE: Lista de Encargados
--------------------------------
Muestra tabla con:
  - Nombre del encargado
  - Balance (tarjeta condicional seg√∫n estado)
  - Bot√≥n "Ver detalles"
  - Bot√≥n "Pagar" (solo si tiene deuda)

Si estado === 'deuda':
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ üî¥ Deuda pendiente          ‚îÇ
  ‚îÇ ‚Ç°15,000                     ‚îÇ
  ‚îÇ [Pagar]                     ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Si estado === 'saldo_favor':
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ üü¢ Saldo a favor            ‚îÇ
  ‚îÇ ‚Ç°5,000                      ‚îÇ
  ‚îÇ Disponible para aplicar     ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Si estado === 'al_dia':
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ ‚úÖ Cuenta al d√≠a            ‚îÇ
  ‚îÇ ‚Ç°0                          ‚îÇ
  ‚îÇ Sin pagos pendientes        ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

MODAL: Registrar Pago
---------------------
Formulario con:
  - Monto (‚Ç°)
  - Fecha de pago
  - M√©todo (efectivo, sinpe, transferencia, tarjeta)
  - Referencia (opcional)
  - N√∫mero de comprobante (requerido si no es efectivo)
  - Fecha de comprobante
  - Adjuntar archivo (imagen/PDF)
  - Detalle (opcional)

Validaciones:
  - Monto > 0
  - Si metodo != 'efectivo': comprobante obligatorio

COMPONENTE: Libro Diario
-------------------------
Tabla con columnas:
  - Fecha
  - Cuenta (encargado/tutor)
  - M√©todo
  - Referencia
  - Debe (entrada)
  - Haber (salida)
  - Saldo acumulado
  - Estado
  - Acciones (ver comprobante)

Filtros:
  - Rango de fechas
  - Tipo de cuenta
  - Estado

COMPONENTE: Bolsa Real
----------------------
Card mostrando:
  - Bolsa real actual (neto)
  - Total debe (ingresos)
  - Total haber (egresos)

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Bolsa Real                  ‚îÇ
‚îÇ ‚Ç°105,000                    ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ Debe: ‚Ç°150,000             ‚îÇ
‚îÇ Haber: ‚Ç°45,000             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò


================================================================================
12. MANTENIMIENTO Y TROUBLESHOOTING
================================================================================

PROBLEMA: Vanessa muestra ‚Ç°7,500 deuda + ‚Ç°7,500 saldo
CAUSA: Vista antigua sin compensaci√≥n
SOLUCI√ìN:
  1. Ejecutar COMPENSACION_AUTOMATICA_TESORERIA.sql en Supabase
  2. Reiniciar backend
  3. Recargar frontend

PROBLEMA: Pago registrado pero NO aparece en libro diario
CAUSA: Estado del pago es 'pendiente' o 'cancelado'
VERIFICACI√ìN:
  SELECT * FROM tesoreria_pagos WHERE id = [pago_id]
SOLUCI√ìN:
  UPDATE tesoreria_pagos SET estado='completado' WHERE id = [pago_id]

PROBLEMA: Obligaci√≥n duplicada
CAUSA: Marcar sesi√≥n como dada dos veces
VERIFICACI√ìN:
  SELECT * FROM tesoreria_obligaciones WHERE sesion_id = [sesion_id]
SOLUCI√ìN:
  Los constraints ux_tesoreria_obligacion_* previenen esto autom√°ticamente.
  Si hay duplicados, verificar que las migraciones se aplicaron correctamente.

PROBLEMA: Aplicaci√≥n FIFO no funciona
CAUSA: fecha_devengo incorrecta o obligacion.estado != 'pendiente'
VERIFICACI√ìN:
  SELECT * FROM tesoreria_obligaciones 
  WHERE cuenta_id = [cuenta_id] AND estado='pendiente'
  ORDER BY fecha_devengo ASC
SOLUCI√ìN:
  Corregir fechas o estados manualmente

PROBLEMA: No se puede eliminar encargado
CAUSA: Tiene cuenta de tesorer√≠a con movimientos
VERIFICACI√ìN:
  SELECT * FROM tesoreria_cuentas_corrientes WHERE encargado_id = [id]
SOLUCI√ìN:
  1. Verificar que no tiene estudiantes activos
  2. Si tiene cuenta con obligaciones/pagos: NO eliminar (integridad contable)
  3. Si la cuenta est√° vac√≠a: eliminarla primero, luego el encargado

PROBLEMA: Saldo_a_favor negativo
IMPOSIBLE: El CASE en la vista garantiza que siempre es >= 0
VERIFICACI√ìN:
  SELECT * FROM tesoreria_saldos_encargados_v1 WHERE saldo_a_favor < 0
  (deber√≠a retornar 0 filas)

PROBLEMA: Balance_neto incorrecto
CAUSA RARA: Posible inconsistencia en aplicaciones
VERIFICACI√ìN MANUAL:
  -- Para un encargado espec√≠fico:
  WITH cuentas AS (
    SELECT id FROM tesoreria_cuentas_corrientes 
    WHERE tipo='encargado' AND encargado_id = [X]
  ),
  ob AS (
    SELECT SUM(monto) AS total
    FROM tesoreria_obligaciones
    WHERE cuenta_id IN (SELECT * FROM cuentas) AND estado='pendiente'
  ),
  pagos AS (
    SELECT SUM(monto) AS total
    FROM tesoreria_pagos
    WHERE cuenta_id IN (SELECT * FROM cuentas) 
      AND direccion='entrada' 
      AND estado IN ('completado','verificado')
  ),
  app AS (
    SELECT SUM(a.monto) AS total
    FROM tesoreria_aplicaciones a
    JOIN tesoreria_obligaciones o ON o.id = a.obligacion_id
    WHERE o.cuenta_id IN (SELECT * FROM cuentas)
  )
  SELECT 
    (SELECT total FROM ob) AS deuda,
    (SELECT total FROM pagos) AS pagado,
    (SELECT total FROM app) AS aplicado,
    ((SELECT total FROM pagos) - (SELECT total FROM app)) AS saldo,
    ((SELECT total FROM ob) - ((SELECT total FROM pagos) - (SELECT total FROM app))) AS balance_neto;

COMANDOS √öTILES:
----------------
-- Ver todas las cuentas con saldos:
SELECT * FROM tesoreria_saldos_encargados_v1;

-- Ver libro diario del mes actual:
SELECT * FROM tesoreria_libro_diario_v1 
WHERE fecha_pago >= date_trunc('month', CURRENT_DATE);

-- Ver pagos sin aplicar:
SELECT p.* FROM tesoreria_pagos p
LEFT JOIN tesoreria_aplicaciones a ON a.pago_id = p.id
WHERE a.id IS NULL AND p.estado IN ('completado','verificado');

-- Ver obligaciones con aplicaciones parciales:
SELECT 
  o.id, 
  o.monto AS obligado, 
  COALESCE(SUM(a.monto), 0) AS aplicado,
  o.monto - COALESCE(SUM(a.monto), 0) AS pendiente
FROM tesoreria_obligaciones o
LEFT JOIN tesoreria_aplicaciones a ON a.obligacion_id = o.id
WHERE o.estado='pendiente'
GROUP BY o.id, o.monto
HAVING o.monto - COALESCE(SUM(a.monto), 0) > 0;

-- Recalcular obligaciones por sesi√≥n:
SELECT 
  s.id AS sesion_id,
  s.fecha,
  COUNT(o.id) AS num_obligaciones,
  SUM(o.monto) AS total_obligado
FROM sesiones_clases s
LEFT JOIN tesoreria_obligaciones o ON o.sesion_id = s.id
WHERE s.estado = 'dada'
GROUP BY s.id, s.fecha
ORDER BY s.fecha DESC;

-- Verificar integridad de aplicaciones (no debe haber sobre-aplicaci√≥n):
SELECT 
  o.id, 
  o.monto, 
  SUM(a.monto) AS aplicado
FROM tesoreria_obligaciones o
JOIN tesoreria_aplicaciones a ON a.obligacion_id = o.id
GROUP BY o.id, o.monto
HAVING SUM(a.monto) > o.monto;
-- Si retorna filas: HAY ERROR (aplicado m√°s de lo obligado)


================================================================================
FIN DEL DOCUMENTO
================================================================================

Este documento describe COMPLETAMENTE el sistema de tesorer√≠a de Linguistika.

Para actualizaciones o dudas, consultar:
  - Migraciones: backend/migrations/017_tesoreria_v2_*.sql
  - C√≥digo backend: backend/routes/tesoreria.js
  - C√≥digo frontend: LInguistika-Studio/views/Tesoreria.tsx
  - Script compensaci√≥n: backend/COMPENSACION_AUTOMATICA_TESORERIA.sql

√öltima actualizaci√≥n: 17 de febrero de 2026
Versi√≥n del sistema: Tesorer√≠a v2 con Compensaci√≥n Autom√°tica
